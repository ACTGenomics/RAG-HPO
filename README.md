# RAG-HPO 

RAG-HPO is a Python-based tool designed to extract Human Phenotype Ontology (HPO) terms from clinical notes. It leverages large language models (LLMs) and Retrieval Augmented Generation (RAG) to provide standardized phenotypic descriptions critical for genomics and clinical research. RAG-HPO itself is not an LLM, but it utilizes LLMs provided by the user to process and annotate clinical text. 

**_Note that protecting patient information and ensuring compliance with institutional guidelines and HIPAA is the end user’s responsibility._**

## How RAG-HPO Works: 

1.	Input Clinical Notes: You provide clinical notes either manually during runtime or by uploading a CSV file.
2.	Extract Key Phrases via LLM: The tool uses a configured LLM to identify clinically relevant phrases from these notes.
3.	Match Phrases to HPO Terms: It employs vector similarity search (FAISS) and fuzzy matching to map these phrases to appropriate HPO terms.
4.	Output Structured Data: Finally, it produces a CSV with patient IDs, phenotypic descriptions, and matched HPO terms.

## What You Need Before You Start:

1.	LLM Configuration:
	An API key for accessing your chosen LLM (cloud-based or local).
	The base URL of the LLM API.
	The LLM model name.
2.	HPO Data and Vectorization:
	A preprocessed HPO embeddings file (G2GHPO_metadata.npy), generated by vectorizing HPO terms. This file is used to match clinical phrases to HPO terms.
	Access to the [HPO ontology](https://hpo.jax.org/data/ontology) and additional validated phrases (HPO_addons.csv) if you plan to update the vector database.
3.	Python & Dependencies:
	Python installed.
	All required packages as listed in requirements.txt.

Note: RAG-HPO has been tested with [Groq.com](https://console.groq.com), which offers free API keys and access to cloud-based LLaMA-3.1 models. However, any OpenAI-compatible LLM should work, including locally hosted ones like [LM-studio](https://lmstudio.ai/).

## Setting Up the Environment:

1. Install Jupyter Notebook or [Microsoft Visual Studio Code](https://code.visualstudio.com/download).
2. Clone this repository and navigate to its directory.
3. Install dependencies with:

```bash
pip install -r requirements.txt
```

Or, using the provided script:

```python
	import os
	import sys
	import subprocess
	
	def install_requirements(requirements_file="requirements.txt"):
	    if not os.path.exists(requirements_file):
	        print(f"Error: {requirements_file} not found.")
	        sys.exit(1)
	    print(f"Installing packages from {requirements_file}...")
	    try:
	        subprocess.check_call([sys.executable, "-m", "pip", "install", "-r", requirements_file])
	        print("All required packages installed successfully.")
	    except subprocess.CalledProcessError as e:
	        print(f"An error occurred while installing dependencies: {e}")
	        sys.exit(1)
	
	if __name__ == "__main__":
	    install_requirements()
```

## Using RAG-HP0: 

1) Prepare Your LLM Configuration: Have your API key, base URL, and model name ready.
2) Run the Jupyter Notebook: Open the .ipynb file in Jupyter or VS Code.
3) Follow the Prompts:
	Configure the LLM by providing the requested API and model details.
	Input your clinical notes (manually or via CSV).
4) Generate Results:
	Run the notebook cells sequentially.
	View the annotated HPO terms in the terminal or save them as a CSV.

## Vectorization of the HPO Database:

RAG-HPO relies on a vectorized database of HPO terms. Before running the annotation tool, you may need to:

1) Obtain HPO Data: Download the HPO database from the [HPO website](https://hpo.jax.org/data/ontology).
2) Incorporate Additional Phrases: Add validated phrases to HPO_addons.csv to improve precision.
3) Vectorize the Database: Use the provided notebook to:
	Process HPO data and generate a .csv for inspection.
	Vectorize the database, producing the G2GHPO_metadata.npy file. This step takes about 10 minutes and can be repeated as needed when HPO is updated (usually monthly).

## Planned Improvements:

- Containerization: A fully containerized version of RAG-HPO is under development, allowing use without manual command line interaction.
- Enhanced Error Handling: We are continually improving error messages and recovery steps for a smoother user experience.

## Feedback and Contributions:

If you have feedback, suggestions, or want to integrate RAG-HPO into existing pipelines, please contact Jennifer Posey (jennifer.posey@bcm.edu) or Brandon Garcia (brandon.garcia@bcm.edu) 
If you’d like to contribute additional validated phrases to the HPO ontology, send us a .csv file following the format of HPO_addons.csv.

View our article on [medRxiv](https://www.medrxiv.org/content/10.1101/2024.12.01.24318253v1). It is also currently in review for publication. 

## Here is an example of how RAG-HPO Compares to other programs! 
![image](https://github.com/user-attachments/assets/5863d790-f887-428b-b63f-c001314143af)
